{% extends "base.html" %}

{% block title %}
Visual Charts - ResultVista
{% endblock %}

{% block head %}
<style>
    :root {
        --primary-blue: #2C3E50;
        --secondary-blue: #3498DB;
        --accent-teal: #1ABC9C;
        --light-gray: #F8F9FA;
        --dark-gray: #6C757D;
        --success-green: #27AE60;
        --warning-orange: #F39C12;
        --danger-red: #E74C3C;
        --purple: #9B59B6;
    }

    * {
        font-family: 'Inter', sans-serif;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        background-attachment: fixed;
    }

    /* Main Container */
    .charts-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        min-height: 80vh;
        margin: 20px auto;
        width: 95%;
    }

    /* Navbar */
    .navbar {
        padding: 15px 40px;
        background-color: var(--primary-blue);
    }

    .dropdown-item:hover {
        background-color: rgba(52, 152, 219, 0.1);
        color: black;
    }

    /* Header Section */
    .charts-header {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
        color: white;
        padding: 30px 40px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header-stats {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .stat-badge {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Charts Content */
    .charts-content {
        padding: 30px 40px;
    }

    /* Section Headers */
    .section-header {
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--light-gray);
    }

    .section-header h3 {
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        margin-bottom: 40px;
    }

    /* Chart Cards */
    .chart-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid #E3E6E8;
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .chart-container canvas {
        width: 100% !important;
        height: 100% !important;
    }

    /* Table Card */
    .table-card {
        grid-column: 1 / -1;
    }

    .top-students-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .top-students-table th {
        background: var(--primary-blue);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .top-students-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
    }

    .top-students-table tr:hover {
        background: rgba(52, 152, 219, 0.05);
    }

    /* Grade Badges in Table */
    .grade-badge {
        padding: 6px 12px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.85rem;
        color: white;
        display: inline-block;
        text-align: center;
        min-width: 35px;
    }

    .grade-A {
        background: #1ABC9C;
    }

    .grade-B {
        background: #3498DB;
    }

    .grade-C {
        background: #F39C12;
    }

    .grade-D {
        background: #E74C3C;
    }

    .grade-F {
        background: #7F8C8D;
    }

    /* Buttons */
    .btn-success {
        background: var(--accent-teal);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 0.95rem;
    }

    .btn-success:hover {
        background: #16a085;
        box-shadow: 0 5px 15px rgba(26, 188, 156, 0.3);
        transform: translateY(-2px);
    }

    /* Controls */
    .chart-controls {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    /* Loader */
    .loader {
        display: none;
        text-align: center;
        padding: 40px;
    }

    .loader.show {
        display: block;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--secondary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @media (max-width: 992px) {
        .charts-container {
            width: 98%;
            margin: 10px auto;
        }

        .charts-header,
        .charts-content {
            padding: 20px;
        }

        .charts-grid {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }
    }

    @media (max-width: 768px) {
        .navbar {
            padding: 10px 15px;
        }

        .btn-primary,
        .btn-success {
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        .header-stats {
            flex-direction: column;
            gap: 10px;
        }
    }

    @media (max-width: 480px) {
        .chart-card {
            padding: 15px;
        }

        .top-students-table th,
        .top-students-table td {
            padding: 8px 10px;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="charts-container">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <!-- Logo on left -->
            <a class="navbar-brand" href="{{ url_for('dashboard') }}"
                style="display: flex; align-items: center; gap: 10px;">
                <img src="{{ url_for('static', filename='logo - Copy.png') }}" width="50px" height="50px" class="me-2"
                    alt="Logo">
                <img src="{{ url_for('static', filename='font_logo - Copy.png') }}" alt="ResultVista" height="20px"
                    class="d-none d-md-block">
            </a>

            <!-- Right side - User Profile Dropdown -->
            <div class="dropdown">
                <button class="btn dropdown-toggle d-flex align-items-center" type="button" id="userDropdown"
                    data-bs-toggle="dropdown"
                    style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; padding: 8px 15px;">

                    {% if user.picture != "default_profile" %}
                    <img src="{{ user.picture }}" alt="Profile"
                        style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                    {% else %}
                    <img src="{{ url_for('static', filename='default.jpg') }}" alt="Profile"
                        style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px;">
                    {% endif %}

                    <span class="d-none d-md-block" style="font-weight: 600;">{{ user.name }}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end"
                    style="border-radius: 10px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 10px; min-width: 250px;">
                    <li>
                        <div class="dropdown-header" style="padding: 15px;">
                            <h6 style="font-weight: 700; color: var(--primary-blue);">{{ user.name }}</h6>
                            <p class="text-muted mb-0" style="font-size: 0.85rem;">{{ user.email }}</p>
                        </div>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('dashboard') }}"
                            style="padding: 10px 15px; border-radius: 5px;">
                            <i class="bi bi-speedometer2 me-2" style="color: var(--secondary-blue);"></i>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('process_results') }}"
                            style="padding: 10px 15px; border-radius: 5px;">
                            <i class="bi bi-table me-2" style="color: var(--accent-teal);"></i>
                            Results Table
                        </a>
                    </li>
                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{ url_for('logout') }}"
                            style="padding: 10px 15px; border-radius: 5px; color: var(--danger-red);">
                            <i class="bi bi-box-arrow-right me-2"></i>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header Section -->
    <div class="charts-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h2 class="fw-bold mb-2">Visual Analytics</h2>
                <p class="mb-0 opacity-75">Interactive charts and performance analysis</p>
            </div>
        </div>

        <div class="header-stats">
            <div class="stat-badge">
                <i class="bi bi-graph-up"></i>
                <span>Overall Average: <strong>{{ chart_data.overall_avg }}%</strong></span>
            </div>
            <div class="stat-badge">
                <i class="bi bi-check-circle"></i>
                <span>Pass Rate: <strong style="color: rgb(36, 185, 96)">{{ chart_data.pass_percentage
                        }}%</strong></span>
            </div>
            <div class="stat-badge">
                <i class="bi bi-trophy"></i>
                <span>Highest Score: <strong>{{ chart_data.overall_max }}%</strong></span>
            </div>
            <div class="stat-badge">
                <i class="bi bi-clipboard-data"></i>
                <span>Subjects: <strong>{{ chart_data.subjects|length }}</strong></span>
            </div>
        </div>
    </div>

    <!-- Charts Content -->
    <div class="charts-content">
        <!-- Loader -->
        <div class="loader" id="chartsLoader">
            <div class="spinner"></div>
            <p>Loading charts...</p>
        </div>

        <!-- Overall Performance Section -->
        <div class="section-header">
            <h3><i class="bi bi-bar-chart"></i> Overall Performance</h3>
        </div>

        <div class="charts-grid">
            <!-- Pass/Fail Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h4 class="chart-title">Pass/Fail Distribution</h4>
                    <i class="bi bi-pie-chart" style="color: var(--secondary-blue);"></i>
                </div>
                <div class="chart-container">
                    <canvas id="passFailChart"></canvas>
                </div>
            </div>

            <!-- Grade Distribution -->
            <div class="chart-card">
                <div class="chart-header">
                    <h4 class="chart-title">Grade Distribution</h4>
                    <i class="bi bi-bar-chart-steps" style="color: var(--accent-teal);"></i>
                </div>
                <div class="chart-container">
                    <canvas id="gradeDistributionChart"></canvas>
                </div>
            </div>

            <!-- Performance Ranges -->
            <div class="chart-card">
                <div class="chart-header">
                    <h4 class="chart-title">Performance Ranges</h4>
                    <i class="bi bi-speedometer2" style="color: var(--warning-orange);"></i>
                </div>
                <div class="chart-container">
                    <canvas id="performanceRangesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Subject-wise Analysis -->
        <div class="section-header">
            <h3><i class="bi bi-book"></i> Subject-wise Analysis</h3>
        </div>

        <div class="charts-grid">
            <!-- Subject Average Marks -->
            <div class="chart-card">
                <div class="chart-header">
                    <h4 class="chart-title">Subject Average Marks</h4>
                    <i class="bi bi-graph-up" style="color: var(--success-green);"></i>
                </div>
                <div class="chart-container">
                    <canvas id="subjectAvgChart"></canvas>
                </div>
            </div>

            <!-- Subject Comparison -->
            <div class="chart-card">
                <div class="chart-header">
                    <h4 class="chart-title">Subject Comparison</h4>
                    <i class="bi bi-clipboard-data" style="color: var(--purple);"></i>
                </div>
                <div class="chart-container">
                    <canvas id="subjectComparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Performers -->
        <div class="section-header">
            <h3><i class="bi bi-trophy"></i> Top Performers</h3>
        </div>

        <div class="chart-card table-card">
            <div class="chart-header">
                <h4 class="chart-title">Top 5 Students</h4>
                <i class="bi bi-award" style="color: var(--warning-orange); font-size:25px;"></i>
            </div>
            <!-- Table for Top Students -->
            <div class="table-responsive">
                <table class="top-students-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Enrollment No</th>
                            <th>Percentage</th>
                            <th>Grade</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in chart_data.top_students %}
                        <tr>
                            <td><strong>#{{ loop.index }}</strong></td>
                            <td><strong>{{ student.name|upper }}</strong></td>
                            <td>{{ student.enrollment }}</td>
                            <td><strong>{{ student.percentage }}%</strong></td>
                            <td>
                                <span class="grade-badge grade-{{ student.grade }}">
                                    {{ student.grade }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chart Controls -->
        <div class="chart-controls">
            <button class="btn btn-success" id="downloadChartsBtn">
                <i class="bi bi-download"></i>
                Download Charts as PDF
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Show loader initially
        const chartsLoader = document.getElementById('chartsLoader');
        chartsLoader.classList.add('show');

        // Chart data from Flask context - PARSE JSON strings
        const chartData = {
            subjects: JSON.parse('{{ chart_data.subjects | tojson | safe }}'),
            subjectAvg: JSON.parse('{{ chart_data.subject_avg | tojson | safe }}'),
            subjectMax: JSON.parse('{{ chart_data.subject_max | tojson | safe }}'),
            subjectMin: JSON.parse('{{ chart_data.subject_min | tojson | safe }}'),
            gradeDistribution: JSON.parse('{{ chart_data.grade_distribution | tojson | safe }}'),
            passFail: JSON.parse('{{ chart_data.pass_fail | tojson | safe }}'),
            performanceRanges: JSON.parse('{{ chart_data.performance_ranges | tojson | safe }}')
        };

        // Max marks from Flask context
        const maxMarks = "{{ max_marks | int }}";

        // Colors for charts
        const colors = {
            primary: '#3498DB',
            success: '#27AE60',
            warning: '#F39C12',
            danger: '#E74C3C',
            teal: '#1ABC9C',
            purple: '#9B59B6',
            gray: '#95A5A6',
            blueLight: '#5DADE2',
            greenLight: '#58D68D',
            yellowLight: '#F7DC6F',
            redLight: '#F1948A'
        };

        // Initialize all charts after page load
        setTimeout(() => {
            initCharts();
            chartsLoader.classList.remove('show');
        }, 500);

        function initCharts() {
            // 1. Pass/Fail Pie Chart
            const passFailCtx = document.getElementById('passFailChart');
            if (passFailCtx) {
                new Chart(passFailCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: ['Pass', 'Fail'],
                        datasets: [{
                            data: [chartData.passFail.PASS, chartData.passFail.FAIL],
                            backgroundColor: [colors.success, colors.danger],
                            borderColor: ['#fff', '#fff'],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label;
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} students (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 2. Grade Distribution Bar Chart
            const gradeDistCtx = document.getElementById('gradeDistributionChart');
            if (gradeDistCtx) {
                new Chart(gradeDistCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['A', 'B', 'C', 'D', 'F'],
                        datasets: [{
                            label: 'Number of Students',
                            data: [
                                chartData.gradeDistribution.A,
                                chartData.gradeDistribution.B,
                                chartData.gradeDistribution.C,
                                chartData.gradeDistribution.D,
                                chartData.gradeDistribution.F
                            ],
                            backgroundColor: [
                                colors.teal,
                                colors.primary,
                                colors.warning,
                                colors.danger,
                                colors.gray
                            ],
                            borderColor: [
                                colors.teal,
                                colors.primary,
                                colors.warning,
                                colors.danger,
                                colors.gray
                            ],
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Students'
                                },
                                grid: {
                                    drawBorder: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // 3. Performance Ranges Chart
            const perfRangesCtx = document.getElementById('performanceRangesChart');
            if (perfRangesCtx) {
                new Chart(perfRangesCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['90-100%', '75-89%', '60-74%', '33-59%', '0-32%'],
                        datasets: [{
                            data: [
                                chartData.performanceRanges["90-100"],
                                chartData.performanceRanges["75-89"],
                                chartData.performanceRanges["60-74"],
                                chartData.performanceRanges["33-59"],
                                chartData.performanceRanges["0-32"]
                            ],
                            backgroundColor: [
                                colors.teal,
                                colors.blueLight,
                                colors.warning,
                                colors.yellowLight,
                                colors.redLight
                            ],
                            borderColor: ['#fff', '#fff', '#fff', '#fff', '#fff'],
                            borderWidth: 2,
                            hoverOffset: 20
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 15
                                }
                            }
                        }
                    }
                });
            }

            // 4. Subject Average Marks Chart
            const subjectAvgCtx = document.getElementById('subjectAvgChart');
            if (subjectAvgCtx && chartData.subjects && chartData.subjectAvg) {
                new Chart(subjectAvgCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartData.subjects,
                        datasets: [{
                            label: 'Average Marks',
                            data: chartData.subjectAvg,
                            backgroundColor: colors.primary + '20',
                            borderColor: colors.primary,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: colors.primary,
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: maxMarks,
                                title: {
                                    display: true,
                                    text: 'Marks'
                                },
                                grid: {
                                    drawBorder: false
                                },
                                ticks: {
                                    // Format y-axis labels as integers
                                    callback: function (value) {
                                        return Math.round(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

            // 5. Subject Comparison Chart
            const subjectCompCtx = document.getElementById('subjectComparisonChart');
            if (subjectCompCtx && chartData.subjects) {
                new Chart(subjectCompCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: chartData.subjects,
                        datasets: [
                            {
                                label: 'Average',
                                data: chartData.subjectAvg,
                                backgroundColor: colors.primary,
                                borderRadius: 6
                            },
                            {
                                label: 'Maximum',
                                data: chartData.subjectMax,
                                backgroundColor: colors.success,
                                borderRadius: 6
                            },
                            {
                                label: 'Minimum',
                                data: chartData.subjectMin,
                                backgroundColor: colors.danger,
                                borderRadius: 6
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: maxMarks,
                                title: {
                                    display: true,
                                    text: 'Marks'
                                },
                                grid: {
                                    drawBorder: false
                                },
                                ticks: {
                                    // Format y-axis labels as integers
                                    callback: function (value) {
                                        return Math.round(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // PDF Generation
        document.getElementById('downloadChartsBtn').addEventListener('click', async function () {
            chartsLoader.classList.add('show');

            try {
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                let yPosition = 20;
                const margin = 20;
                const pageWidth = pdf.internal.pageSize.getWidth() - (2 * margin);
                const maxChartWidth = pageWidth * 0.9; // Use 90% of page width
                const maxChartHeight = 50;

                // Add clean header
                pdf.setFontSize(16);
                pdf.setTextColor(44, 62, 80);
                pdf.text('Analytics Charts Report', margin, yPosition);

                pdf.setFontSize(10);
                pdf.setTextColor(100);
                yPosition += 6;
                pdf.text(`Generated on ${new Date().toLocaleDateString()}`, margin, yPosition);
                yPosition += 4;
                pdf.text(`For: {{ user.name }}`, margin, yPosition);

                yPosition += 12;

                // Get all chart canvases
                const chartElements = document.querySelectorAll('.chart-card:not(.table-card)');

                for (let i = 0; i < chartElements.length; i++) {
                    const card = chartElements[i];
                    const canvas = card.querySelector('canvas');
                    const title = card.querySelector('.chart-title');

                    if (!canvas) continue;

                    const chart = Chart.getChart(canvas);

                    if (chart) {
                        // Check if we need a new page
                        if (yPosition + maxChartHeight + 40 > pdf.internal.pageSize.getHeight() - 20) {
                            pdf.addPage();
                            yPosition = 20;
                        }

                        // Add chart title
                        if (title) {
                            pdf.setFontSize(12);
                            pdf.setTextColor(44, 62, 80);
                            const titleText = title.textContent;
                            pdf.text(titleText, margin, yPosition);
                            yPosition += 8;
                        }

                        // Create temporary canvas for export
                        const tempCanvas = document.createElement('canvas');
                        const originalWidth = canvas.width;
                        const originalHeight = canvas.height;

                        // Set reasonable size for PDF (not too large)
                        const exportWidth = 800; // Fixed width for consistent quality
                        const exportHeight = Math.round((exportWidth * originalHeight) / originalWidth);

                        tempCanvas.width = exportWidth;
                        tempCanvas.height = exportHeight;
                        const tempCtx = tempCanvas.getContext('2d');

                        // Fill with white background
                        tempCtx.fillStyle = '#FFFFFF';
                        tempCtx.fillRect(0, 0, exportWidth, exportHeight);

                        // Draw the chart scaled to new size
                        tempCtx.drawImage(canvas, 0, 0, originalWidth, originalHeight, 0, 0, exportWidth, exportHeight);

                        // Get image data
                        const imageData = tempCanvas.toDataURL('image/png', 1.0);

                        // Calculate dimensions for PDF (maintain aspect ratio)
                        const aspectRatio = exportWidth / exportHeight;
                        let chartWidth = maxChartWidth;
                        let chartHeight = chartWidth / aspectRatio;

                        // Limit height if too tall
                        if (chartHeight > maxChartHeight) {
                            chartHeight = maxChartHeight;
                            chartWidth = chartHeight * aspectRatio;
                        }

                        // Center the chart horizontally
                        const xPosition = margin + ((pageWidth - chartWidth) / 2);

                        // Add subtle border around chart
                        pdf.setDrawColor(220, 220, 220);
                        pdf.setLineWidth(0.5);
                        pdf.rect(
                            xPosition - 2,
                            yPosition - 2,
                            chartWidth + 4,
                            chartHeight + 4
                        );

                        // Add chart to PDF
                        pdf.addImage(
                            imageData,
                            'PNG',
                            xPosition,
                            yPosition,
                            chartWidth,
                            chartHeight
                        );

                        yPosition += chartHeight + 15;

                        // Add small separator between charts
                        if (i < chartElements.length - 1) {
                            pdf.setDrawColor(240, 240, 240);
                            pdf.line(margin, yPosition - 5, margin + pageWidth, yPosition - 5);
                            yPosition += 10;
                        }
                    }
                }

                // Add summary section
                if (chartElements.length > 0) {
                    yPosition += 5;
                    pdf.setDrawColor(200, 200, 200);
                    pdf.line(margin, yPosition, margin + pageWidth, yPosition);
                    yPosition += 10;

                    pdf.setFontSize(10);
                    pdf.setTextColor(100);
                    pdf.text(`Total Charts: ${chartElements.length}`, margin, yPosition);
                }

                // Add page numbers
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(150);
                    pdf.text(
                        `Page ${i} of ${totalPages}`,
                        pdf.internal.pageSize.getWidth() / 2,
                        pdf.internal.pageSize.getHeight() - 10,
                        { align: 'center' }
                    );
                }

                // Save PDF
                pdf.save("charts_report.pdf");

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                chartsLoader.classList.remove('show');
            }
        });
    });
</script>
{% endblock %}